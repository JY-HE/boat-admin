import { DirectiveBinding, ObjectDirective } from 'vue';

const DEFAULT_PLACEHOLDER =
    'data:image/svg+xml;base64,ICAgICAgIDxzdmcNCiAgICAgICAgICAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyINCiAgICAgICAgICAgIGRhdGEtbmFtZT0iTGF5ZXIgMSINCiAgICAgICAgICAgIHdpZHRoPSI3OTUuMzA5NjQiDQogICAgICAgICAgICBoZWlnaHQ9IjUyNC44Nzc3MiINCiAgICAgICAgICAgIHZpZXdCb3g9IjAgMCA3OTUuMzA5NjQgNTI0Ljg3NzcyIg0KICAgICAgICAgICAgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiDQogICAgICAgID4NCiAgICAgICAgICAgIDxjaXJjbGUgY3g9IjIyOS44MjAxOCIgY3k9IjEyOC45MzQ5MiIgcj0iMTAwIiBmaWxsPSIjMDBDODhDIiAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNNzQxLjU5MjU5LDIyNS41NDkyNGMtLjg0MTcyLTMuMzAzNzctMy41ODAyMy01Ljc3NTU4LTYuNDM1ODItNy42MzgyMnMtNS45OTgwNS0zLjM1OTY0LTguNDM2NjktNS43NDI3NGMtMi40MzgtMi4zODMtNC4wNzc4NC02LjAwNjY3LTIuOTQ2LTkuMjIyNjMsMS4zNzU3Ni0zLjkwODU1LDUuOTYwMzItNS40NzA0Myw5Ljk2NzkxLTYuNTI0MmExMDc3LjIwMTA2LDEwNzcuMjAxMDYsMCwwLDAtMTEwLjQzMDE4LTYuMTYwNTksNi42NDI1Miw2LjY0MjUyLDAsMCwwLTExLjk4ODMsMy45NjExNlYzMTIuNzg1NzdoMTMuMzIxNzdWMjM5Ljk1NDE0cTQ3LjQ2MzY5LjExNSw5NC45MjguMjI5OTRjNS4xMjMxNi4wMTIzNiwxMC40NTM4Mi0uMDIwMjUsMTUuMDU5ODQtMi4yNjRDNzM5LjIzOTgxLDIzNS42NzY0NCw3NDIuODU3NzcsMjMwLjUxNDE3LDc0MS41OTI1OSwyMjUuNTQ5MjRaIg0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMDIuMzQ1MTggLTE4Ny41NjExNCkiDQogICAgICAgICAgICAgICAgZmlsbD0iI0I5QzZFMCINCiAgICAgICAgICAgIC8+DQogICAgICAgICAgICA8cGF0aA0KICAgICAgICAgICAgICAgIGQ9Ik04MTUuMTQ2NTgsNDM4LjAxMDQxVjM5OC4wNDUxaDMwLjY0MDA3YTQxLjI5NzIyLDQxLjI5NzIyLDAsMCwwLDQxLjI5NzQ4LTQxLjI5NzQxdi0uMDAwMDhoLTIzMy4xMzFhMTguNjUwNTEsMTguNjUwNTEsMCwwLDEsMTguNjUwNDctMTguNjUwNDdIODM1LjEyOTIzdi00LjYzNjM2YzAtMTUuODMyOTQtMTAuOTYwNTMtMjguNjY4MDctMjQuNDgwNy0yOC42NjgwN0g2MDguMDkzMjRjLTMxLjE5Njg4LDAtNTkuNjk5NDksMjAuMDk0MTMtNzQuNDAxNTcsNTEuOTU0OUg1MDEuMDcyMmExMC42NTYxNiwxMC42NTYxNiwwLDAsMC03LjQxNTQ0LDMuMDAyODVsLTIwLjYyNzI3LDE5Ljk4MjY1YTEwLjY1NzM1LDEwLjY1NzM1LDAsMCwwLDcuNDE1NDMsMTguMzEyaDI1LjYzNjZ2MzkuOTY1MzFIMzg4LjMwNzQ1YTEwLjY1NzYxLDEwLjY1NzYxLDAsMCwwLTcuOTY1NzQsMy41NzcwNWwtMjMuNjgzMjIsMjYuNjQzM2ExMC42NTc2NCwxMC42NTc2NCwwLDAsMCw3Ljk2NTc1LDE3LjczOEg0MzcuODY5OWExMC42NTYyNiwxMC42NTYyNiwwLDAsMSw5LjAzNTEzLDUuMDA2bDEyLjg1MzQyLDIwLjU1MDkzYTEwLjY1NzY2LDEwLjY1NzY2LDAsMCwxLTguMjEzNTcsMTYuMjc3MTNsLTE1OC44NjQsMTIuMjg5NDZhMTAuNjU3MTksMTAuNjU3MTksMCwwLDAtOC45NTk2Nyw2LjM5NTU3bC0zMy42NDA3Myw3Ny43OTM4YTEwLjY1NzM2LDEwLjY1NzM2LDAsMCwwLDkuNzgxODgsMTQuODg3NDdINzkwLjY3NTYzYTIxMy41NTQzNiwyMTMuNTU0MzYsMCwwLDAsMzguNzY1MTgtMy41MzQ1M2M5NC43Njg2NS0xNy40ODYyMSwxNjIuODg1My0xMDEuMjU1NzgsMTYyLjg4NTMtMTk3LjYyNDExdi0uMDAwMDhaTTU0Ni4wNDY4MywzOTguMDQ1MUg3NzUuMTgxMjd2MzkuOTY1MzFINTQ2LjA0NjgzWm0zMzMuMDQ0MjQsODUuMjU5NDFhNDIuNjI5NDEsNDIuNjI5NDEsMCwwLDEtNDIuNjI5NjYsNDIuNjI5NThINDkyLjc1OTc1VjUyNS45MzRhNDIuNjI5ODMsNDIuNjI5ODMsMCwwLDEsNDIuNjI5NjctNDIuNjI5NTlIODc5LjA5MTA3WiINCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjAyLjM0NTE4IC0xODcuNTYxMTQpIg0KICAgICAgICAgICAgICAgIGZpbGw9IiMzRjUxQjUiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNODIzLjEzOTY0LDUwNC42MTkyNkg1MzguMDUzNzdhNi42Njg3Miw2LjY2ODcyLDAsMCwwLTYuNjYwODgsNi42NjA4OHYxNS45ODYxMkg4MjkuODAwNTNWNTExLjI4MDE0QTYuNjY4NzMsNi42Njg3MywwLDAsMCw4MjMuMTM5NjQsNTA0LjYxOTI2Wk01OTQuMDA1Miw1MDcuMjgzNjFoMzEuNDM3NTZ2MTcuMzE4M0g1OTQuMDA1MlptLTIuNjY0MzUsMTcuMzE4M0g1NTkuOTAzMjl2LTE3LjMxODNoMzEuNDM3NTZabTM2Ljc2NjI2LTE3LjMxODNINjU5LjU0NHYxNy4zMTgzSDYyOC4xMDcxMVptMzQuMTAxMjYsMGgzMS40MzY5MXYxNy4zMTgzSDY2Mi4yMDgzN1ptMzQuMTAxMjYsMGgzMS40Mzc1NXYxNy4zMTgzSDY5Ni4zMDk2M1ptMzQuMTAxOTEsMGgzMS40Mzc1NXYxNy4zMTgzSDczMC40MTE1NFptMzQuMTAxOTEsMEg3OTUuOTUxdjE3LjMxODNINzY0LjUxMzQ1Wm0tMjMwLjQ1NjIxLDMuOTk2NTNhNC4wMDA5LDQuMDAwOSwwLDAsMSwzLjk5NjUzLTMuOTk2NTNoMTkuMTg1MTd2MTcuMzE4M2gtMjMuMTgxN1ptMjkzLjA3ODkzLDEzLjMyMTc3SDc5OC42MTUzNnYtMTcuMzE4M2gyNC41MjQyOGE0LjAwMDg5LDQuMDAwODksMCwwLDEsMy45OTY1MywzLjk5NjUzWiINCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjAyLjM0NTE4IC0xODcuNTYxMTQpIg0KICAgICAgICAgICAgICAgIGZpbGw9IiMzRjUxQjUiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHJlY3QgeD0iNTg0LjgyNTY5IiB5PSIxMjkuMjIxMTciIHdpZHRoPSIxNy4zMTgzIiBoZWlnaHQ9IjcxLjkzNzU2IiBmaWxsPSIjM0Y1MUI1IiAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNNDg2LjA5ODg3LDY0My4xNjU2NkgyMDYuMzQxNzFhMy45OTY1MywzLjk5NjUzLDAsMSwxLDAtNy45OTMwNkg0ODYuMDk4ODdhMy45OTY1MywzLjk5NjUzLDAsMSwxLDAsNy45OTMwNloiDQogICAgICAgICAgICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTIwMi4zNDUxOCAtMTg3LjU2MTE0KSINCiAgICAgICAgICAgICAgICBmaWxsPSIjY2NjIg0KICAgICAgICAgICAgLz4NCiAgICAgICAgICAgIDxwYXRoDQogICAgICAgICAgICAgICAgZD0iTTM2Mi4yMDY0MSw2NjcuMTQ0ODRIMjQ2LjMwN2EzLjk5NjUzLDMuOTk2NTMsMCwxLDEsMC03Ljk5MzA2SDM2Mi4yMDY0MWEzLjk5NjUzLDMuOTk2NTMsMCwwLDEsMCw3Ljk5MzA2WiINCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjAyLjM0NTE4IC0xODcuNTYxMTQpIg0KICAgICAgICAgICAgICAgIGZpbGw9IiNjY2MiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNODczLjc2MjM3LDY0My4xNjU2Nkg1OTQuMDA1MmEzLjk5NjUzLDMuOTk2NTMsMCwxLDEsMC03Ljk5MzA2SDg3My43NjIzN2EzLjk5NjUzLDMuOTk2NTMsMCwxLDEsMCw3Ljk5MzA2WiINCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjAyLjM0NTE4IC0xODcuNTYxMTQpIg0KICAgICAgICAgICAgICAgIGZpbGw9IiNjY2MiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNNzAxLjkxMTU0LDY2Ny4xNDQ4NEg0MjIuMTU0MzhhMy45OTY1MywzLjk5NjUzLDAsMSwxLDAtNy45OTMwNkg3MDEuOTExNTRhMy45OTY1MywzLjk5NjUzLDAsMSwxLDAsNy45OTMwNloiDQogICAgICAgICAgICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTIwMi4zNDUxOCAtMTg3LjU2MTE0KSINCiAgICAgICAgICAgICAgICBmaWxsPSIjY2NjIg0KICAgICAgICAgICAgLz4NCiAgICAgICAgICAgIDxwYXRoDQogICAgICAgICAgICAgICAgZD0iTTQ4Ni4wOTg4Nyw2ODguNDU5NjhIMjA2LjM0MTcxYTMuOTk2NTQsMy45OTY1NCwwLDAsMSwwLTcuOTkzMDdINDg2LjA5ODg3YTMuOTk2NTQsMy45OTY1NCwwLDAsMSwwLDcuOTkzMDdaIg0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMDIuMzQ1MTggLTE4Ny41NjExNCkiDQogICAgICAgICAgICAgICAgZmlsbD0iI2NjYyINCiAgICAgICAgICAgIC8+DQogICAgICAgICAgICA8cGF0aA0KICAgICAgICAgICAgICAgIGQ9Ik02NTMuOTUzMTcsNzEyLjQzODg2SDUzOC4wNTM3N2EzLjk5NjUzLDMuOTk2NTMsMCwwLDEsMC03Ljk5MzA2aDExNS44OTk0YTMuOTk2NTMsMy45OTY1MywwLDAsMSwwLDcuOTkzMDZaIg0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMDIuMzQ1MTggLTE4Ny41NjExNCkiDQogICAgICAgICAgICAgICAgZmlsbD0iI2NjYyINCiAgICAgICAgICAgIC8+DQogICAgICAgICAgICA8cGF0aA0KICAgICAgICAgICAgICAgIGQ9Ik00MDMuNTAzOSw3MTIuNDM4ODZIMjg3LjYwNDVhMy45OTY1MywzLjk5NjUzLDAsMSwxLDAtNy45OTMwNkg0MDMuNTAzOWEzLjk5NjUzLDMuOTk2NTMsMCwwLDEsMCw3Ljk5MzA2WiINCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjAyLjM0NTE4IC0xODcuNTYxMTQpIg0KICAgICAgICAgICAgICAgIGZpbGw9IiNjY2MiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNODczLjc2MjM3LDY4OC40NTk2OEg1OTQuMDA1MmEzLjk5NjUzLDMuOTk2NTMsMCwwLDEsMC03Ljk5MzA3SDg3My43NjIzN2EzLjk5NjU0LDMuOTk2NTQsMCwwLDEsMCw3Ljk5MzA3WiINCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjAyLjM0NTE4IC0xODcuNTYxMTQpIg0KICAgICAgICAgICAgICAgIGZpbGw9IiNjY2MiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHBhdGgNCiAgICAgICAgICAgICAgICBkPSJNOTkzLjY1ODI5LDcxMi40Mzg4Nkg3MTMuOTAxMTNhMy45OTY1MywzLjk5NjUzLDAsMCwxLDAtNy45OTMwNkg5OTMuNjU4MjlhMy45OTY1MywzLjk5NjUzLDAsMCwxLDAsNy45OTMwNloiDQogICAgICAgICAgICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTIwMi4zNDUxOCAtMTg3LjU2MTE0KSINCiAgICAgICAgICAgICAgICBmaWxsPSIjY2NjIg0KICAgICAgICAgICAgLz4NCiAgICAgICAgPC9zdmc+';

interface LazyImageElement extends HTMLImageElement {
    __io__?: IntersectionObserver;
    __src__?: string;
}

const lazyDirective: ObjectDirective<LazyImageElement> = {
    // 图片已插入 DOM、布局完成后才开始观察
    mounted(el, binding: DirectiveBinding<string>) {
        const realSrc = binding.value;
        if (!realSrc) return;

        // 先显示占位图
        el.src = DEFAULT_PLACEHOLDER;
        el.__src__ = realSrc;

        // 创建 IntersectionObserver，10%可见即触发
        const io = new IntersectionObserver(
            (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target as LazyImageElement;
                        if (img.__src__) {
                            // 切换到真实图并淡入
                            img.style.transition = 'opacity 0.4s';
                            img.style.opacity = '0';
                            img.src = img.__src__;
                            img.onload = () => {
                                img.style.opacity = '1';
                            };
                        }
                        observer.unobserve(img);
                    }
                });
            },
            { threshold: 0.1 }
        );

        io.observe(el);
        el.__io__ = io;
    },

    // 卸载时断开 observer
    unmounted(el) {
        el.__io__?.disconnect();
        delete el.__io__;
    },
};

export default lazyDirective;
